---
import { replacePlaceholdersInHtml } from '@libs/placeholder'
import Code from '@components/shortcodes/Code.astro'
import { getVersionedDocsPath } from '@libs/path'

interface Props {
  /**
   * Defines if extra JS snippet should be added to StackBlitz or not.
   * @default false
   */
  addStackblitzJs?: boolean
  /**
   * The example code.
   * If an array is passed, elements will be joined with a new line.
   */
  code: string | string[]
  /**
   * The CSS class(es) to be added to the preview wrapping `div` element.
   */
  class?: string
  /**
   * The preview wrapping `div` element ID.
   */
  id?: string
  /**
   * Language used to display the code.
   * @default 'html'
   */
  lang?: string
  /**
   * Defines if the markup should be visible or not.
   * @default true
   */
  showMarkup?: boolean
  /**
   * Defines if the preview should be visible or not.
   * @default true
   */
  showPreview?: boolean
  /**
   * Defines if the toolbar with Stackblitz and copy buttons should be visible or not.
   * @default true
   */
  showToolbar?: boolean
  /**
   * Defines label to complete 'Edit code on Stackblitz' and/or 'Copy code to clipboard' buttons aria-labels.
   */
  buttonLabel?: string
}

const {
  addStackblitzJs = false,
  code,
  class: className,
  id,
  lang = 'html',
  showMarkup = true,
  showPreview = true,
  showToolbar = true,
  buttonLabel
} = Astro.props

let markup = Array.isArray(code) ? code.join('\n') : code
markup = replacePlaceholdersInHtml(markup)

const stackblitzLabel = buttonLabel ? `Edit ${buttonLabel} code on StackBlitz` : 'Edit code on StackBlitz'
const clipboardLabel = buttonLabel ? `Copy ${buttonLabel} code to clipboard` : 'Copy code to clipboard'

const simplifiedMarkup = markup
  .replace(
    /<svg.*class="bd-placeholder-img(?:-lg)?(?: *?bd-placeholder-img-lg)? ?(.*?)".*?<\/svg>/g,
    (match, classes) => `<img src="..."${classes ? ` class="${classes}"` : ''} alt="..." />`
  )
  .replace(
    /<img.*class="bd-placeholder-img(?:-lg)?(?: *?bd-placeholder-img-lg)? ?(.*?)".*?>/g,
    (match, classes) => `<img src="..."${classes ? ` class="${classes}"` : ''} alt="..." />`
  )
---

<div class="bd-example-snippet bd-code-snippet">
  {
    showPreview && (
      <div id={id} class:list={['bd-example order-first m-none border-none', className, showToolbar ? '' : 'border-default border-thin border-bottom']}>
        <Fragment set:html={markup} />
      </div>
    )
  }

  {
    showMarkup && (
      <>
        <Code code={simplifiedMarkup} lang={lang} nestedInExample={true} buttonLabel={buttonLabel} />
        {showPreview && showToolbar && (
          <div class="d-flex order-first align-items-center highlight-toolbar ps-large border-top border-bottom border-thin border-default">
            <small class="font-monospace text-muted text-uppercase my-sm">{lang}</small>
            <!-- OUDS mod: buttons are not displayed on small screens -->
            <div class="d-none d-md-flex ms-auto">
              <button type="button" class="btn btn-minimal btn-icon btn-edit m-2xsmall me-xs"
                title={stackblitzLabel}
                data-sb-js-snippet={addStackblitzJs ? true : undefined}>
                <svg aria-hidden="true">
                  <use xlink:href={getVersionedDocsPath('/assets/img/ouds-web-sprite.svg#lightning-charge-fill')} />
                </svg>
              </button>
              <button type="button" class="btn btn-minimal btn-icon btn-clipboard m-2xs" title={clipboardLabel}>
                <svg aria-hidden="true">
                  <use xlink:href={getVersionedDocsPath('/assets/img/ouds-web-sprite.svg#copy')} />
                </svg>
              </button>
            </div>
          </div>
        )}
      </>
    )
  }
</div>
