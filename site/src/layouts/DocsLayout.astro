---
import type { MarkdownHeading } from 'astro'
import type { CollectionEntry } from 'astro:content'
import { getConfig } from '@libs/config'
import { getData } from '@libs/data'
import type { LayoutOverridesHTMLAttributes } from '@libs/layout'
import { getSlug, processMarkdownToHtml } from '@libs/utils'
import { getVersionedDocsPath } from '@libs/path'
import BaseLayout from '@layouts/BaseLayout.astro'
import DocsSidebar from '@components/DocsSidebar.astro'
import TableOfContents from '@components/TableOfContents.astro'
import GitHubIcon from '@components/icons/GitHubIcon.astro'

interface Props {
  frontmatter: CollectionEntry<'docs'>['data']
  headings?: MarkdownHeading[]
  id: CollectionEntry<'docs'>['id']
}

const { frontmatter, headings, id } = Astro.props

// Extract the directory/section from the ID (format: "directory/filename.mdx")
const parentDirectory = id?.includes('/') ? id.split('/')[0] : ''

const bodyProps: LayoutOverridesHTMLAttributes<'body'> = {}

if (frontmatter.toc) {
  bodyProps['data-bs-spy'] = 'scroll'
  bodyProps['data-bs-target'] = '#TableOfContents'
}

let currentComponentsTypesNames = [frontmatter.title]
if(frontmatter.types) {
  currentComponentsTypesNames = frontmatter.types
}
let componentsVersions: {name: string, version: string}[] = [];
currentComponentsTypesNames.forEach((name) => {
  getData('_components-versions').every((component) => {
    const slug =  name.toLowerCase().split(' ').filter((part) => part !== '-').join('-');
    if(component.name === slug) {
      componentsVersions.push({name, version: component.value})
      return false
    }
    return true
  })
})
const isComponent = componentsVersions.length > 0;
const multipleComponents = componentsVersions.length > 1 ? 's' : ''
---

<BaseLayout {...Astro.props} layout="docs" overrides={{ body: bodyProps }}>
  <div slot="main" class="container-fluid container-max-width bd-gutter mt-large my-md-2xlarge bd-layout">
    <aside class="bd-sidebar">
      <h1 id="docs-nav" class="visually-hidden">Docs navigation</h1>
      <div class="offcanvas-lg offcanvas-start" tabindex="-1" id="bdSidebar" aria-labelledby="bdSidebarOffcanvasLabel">
        <div class="offcanvas-header border-bottom">
          <h5 class="offcanvas-title" id="bdSidebarOffcanvasLabel">Browse docs</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="offcanvas"
            aria-label="Close"
            data-bs-target="#bdSidebar"
            data-toggle="tooltip"
            data-bs-placement="bottom"
            data-bs-title="Close"></button>
        </div>

        <div class="offcanvas-body">
          <DocsSidebar />
        </div>
      </div>
    </aside>

    <main class="bd-main order-1">
      <div class="bd-intro pt-small ps-lg-small">
        <div class="d-md-flex flex-md-row-reverse align-items-center justify-content-between">
          <div class="d-flex gap-medium mb-large mb-md-none d-flex text-nowrap">
            {
              // This is needed because we want to show the badge if show_badge isn't present or is set to false
              frontmatter.added &&
                ((frontmatter.added.show_badge !== undefined && frontmatter.added.show_badge === true) ||
                  frontmatter.added.show_badge === undefined) && (
                  <p class="mb-none">
                    <span class="tag tag-small">Added in v{frontmatter.added.version}</span>
                  </p>
                )
            }
            <a
              class="btn btn-default btn-icon"
              href={`${getConfig().repo}/blob/v${getConfig().current_version}-ouds-web/site/src/content/docs/${id}`}
              title="View this file on GitHub"
              target="_blank"
              rel="noopener"
            >
              <span class="visually-hidden">View this file on GitHub</span>
              <GitHubIcon class="pe-none" />
            </a>
            <a href={`${getConfig().repo}/issues/new?template=doc_report.yml&title=Update+the+${id.slice(0, -4)}+page+on+${getConfig().brand}&version=${getConfig().docs_version}&labels=ðŸ’ª+contribution&what-happened=I+report+a+bug+concerning+${id.slice(0, -4)}+:`} class="btn btn-icon btn-default add-user-agent" title={`Report a bug on the ${id.slice(0, -4).split('/').pop()} page`} target="_blank" rel="noopener">
              <svg aria-hidden="true">
                <use xlink:href={`${getVersionedDocsPath('/assets/img/ouds-web-sprite.svg#bug')}`}></use>
              </svg>
              <span class="visually-hidden">Report a bug on the {id.slice(0, -4).split('/').pop()} page</span>
            </a>
            <a href={`${getConfig().repo}/discussions/new?category=q-a&title=Question+about+${id.slice(0, -4).split('/').pop()}+on+${getConfig().brand}&body=I+have+a+question+about+...`} class="btn btn-icon btn-default" title={`Ask a question about ${id.slice(0, -4).split('/').pop()} topic`} target="_blank" rel="noopener">
              <svg aria-hidden="true">
                <use xlink:href={`${getVersionedDocsPath('/assets/img/ouds-web-sprite.svg#message-talk')}`}></use>
              </svg>
              <span class="visually-hidden">Ask a question about {id.slice(0, -4).split('/').pop()} topic</span>
            </a>
          </div>
          <h1 class="bd-title mb-none" id="content">{frontmatter.title}</h1>
        </div>
        <div class="bd-subtitle mt-small">
          {frontmatter.description && <Fragment set:html={processMarkdownToHtml(frontmatter.description)} />}
        </div>
      </div>

      <div class="bd-toc mt-large mb-4xlarge my-lg-none mb-lg-4xlarge px-sm-2xsmall text-muted">
        {
          frontmatter.toc && headings && (
            <h2 class="mb-none" id="docs-toc">
              <button
                class="btn btn-default p-md-none mb-small mb-md-none text-decoration-none bd-toc-toggle d-md-none"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#tocContents"
                aria-expanded="false"
                aria-controls="tocContents"
              >
                On this page
                <svg class="bi d-md-none ms-small" aria-hidden="true">
                  <use xlink:href={getVersionedDocsPath('/assets/img/ouds-web-sprite.svg#chevron-expand')} />
                </svg>
              </button>
              <span class="d-none d-md-block h6 my-small ms-large">On this page</span>
            </h2>
            <hr class="d-none d-md-block my-small ms-large" />
            <div class="collapse bd-toc-collapse ms-md-xsmall" id="tocContents">
              <nav id="TableOfContents" aria-labelledby="docs-toc">
                <TableOfContents headings={headings} />
              </nav>
            </div>
          )
        }
      </div>

      <div class="bd-content ps-lg-small">
        {isComponent && (
          <p class="d-inline"><a class="link" href={getVersionedDocsPath('/getting-started/versioning')} id="componentVersions">Component{`${multipleComponents}`} design version{`${multipleComponents}`}:</a></p>
          <div class="d-inline align-middle" role="group"  aria-labelledby="componentVersions">
            <ul class="list-unstyled d-inline-flex flex-wrap column-gap-xsmall row-gap-medium mb-none align-middle">
              {componentsVersions.map((component) => (
                <li class="tag tag-info tag-muted">{component.name} v{component.version}</li>
              ))}
            </ul>
          </div>
        )}
        {
          frontmatter.sections && (
            <div class="row g-medium">
              {frontmatter.sections.map((section) => {
                return (
                  <div class="col-md-6">
                    <a
                      class="d-block text-decoration-none"
                      href={getVersionedDocsPath(
                        `${parentDirectory ? parentDirectory + '/' : ''}${getSlug(section.title)}/`
                      )}
                    >
                      <strong class="d-block h5 mb-none">{section.title}</strong>
                      <span class="text-default">{section.description}</span>
                    </a>
                  </div>
                )
              })}
            </div>
          )
        }

        <slot />
      </div>
    </main>
  </div>
</BaseLayout>
